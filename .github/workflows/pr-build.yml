name: PR Build Release APK

on:
  # Trigger on PR events
  pull_request:
    types: [opened, synchronize, reopened]
  
  # Trigger on PR comments containing specific keywords
  issue_comment:
    types: [created]

jobs:
  # Check if this is a PR comment with build trigger keyword
  check-comment:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      pr_sha: ${{ steps.check.outputs.pr_sha }}
    steps:
      - name: Check if comment triggers build
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase();
            const isPR = !!context.payload.issue.pull_request;
            const shouldBuild = isPR && (
              comment.includes('/build') || 
              comment.includes('build apk') || 
              comment.includes('build release')
            );
            
            core.setOutput('should_build', shouldBuild);
            
            if (shouldBuild) {
              // Get PR details
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });
              
              core.setOutput('pr_number', context.payload.issue.number);
              core.setOutput('pr_sha', pr.data.head.sha);
              
              // React to comment with eyes emoji
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'eyes'
              });
            }

  build-apk:
    # Run for PR events or when comment triggers build
    if: |
      always() && (
        github.event_name == 'pull_request' || 
        (github.event_name == 'issue_comment' && needs.check-comment.outputs.should_build == 'true')
      )
    needs: [check-comment]
    runs-on: ubuntu-latest
    
    steps:
      # Checkout code - different approach for PR vs comment
      - name: Checkout PR code (from pull_request event)
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout PR code (from issue_comment event)
        if: github.event_name == 'issue_comment'
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-comment.outputs.pr_sha }}
          fetch-depth: 0
      
      # Set up JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      # Grant execute permission for gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      # Create google-services.json from secrets
      - name: Create google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo "$GOOGLE_SERVICES_JSON" > app/google-services.json
      
      # Decode keystore for release signing
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          printf '%s' "$KEYSTORE_BASE64" | base64 --decode > app/release.keystore
      
      # Build signed release APK
      - name: Build Signed Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          KEYSTORE_PATH="$GITHUB_WORKSPACE/app/release.keystore"
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=$KEYSTORE_PATH \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
            --stacktrace --no-daemon
      
      # Get version information
      - name: Get version information
        id: version_info
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName | tail -n 1)
          VERSION_CODE=$(./gradlew -q printVersionCode | tail -n 1)
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION_NAME} (${VERSION_CODE})"
      
      # Get PR number for artifact naming
      - name: Get PR number
        id: pr_info
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "PR_NUMBER=${{ needs.check-comment.outputs.pr_number }}" >> $GITHUB_OUTPUT
          fi
      
      # Upload Release APK as artifact
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        id: upload_artifact
        with:
          name: PR-${{ steps.pr_info.outputs.PR_NUMBER }}-release-apk
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30
      
      # Comment on PR with build results
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr_info.outputs.PR_NUMBER }};
            const versionName = '${{ steps.version_info.outputs.VERSION_NAME }}';
            const versionCode = '${{ steps.version_info.outputs.VERSION_CODE }}';
            const runId = context.runId;
            const sha = context.sha;
            
            const comment = `### ‚úÖ Release APK Build Successful!
            
            **Version:** ${versionName} (${versionCode})
            **Commit:** ${sha.substring(0, 7)}
            
            üì¶ **Download APK:**
            You can download the release APK from the [workflow artifacts](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}).
            
            > Built by [PR Build workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId})`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
      
      # React to comment with success (if triggered by comment)
      - name: React to comment with success
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
      
      # Handle build failure
      - name: Comment on PR (failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr_info.outputs.PR_NUMBER }};
            const runId = context.runId;
            
            const comment = `### ‚ùå Release APK Build Failed
            
            The build encountered an error. Please check the [workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}) for details.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
      
      # React to comment with failure (if triggered by comment)
      - name: React to comment with failure
        if: failure() && github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused'
            });
